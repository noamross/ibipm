---
title: "Individual-based Integral Projection Models: The role of size-structure on extinction risk and establishment success"
author: "Sebastian Schreiber and Noam Ross"
date: "April 8, 2015"
output: html_document
---
$\def\N{\mathbb N}$
$\def\R{\mathbb R}$
$\def\P{\mathbb P}$
$\def\N{\mathbb N}$
$\def\S{\mathcal S}$
$\def\n{\mathbf n}$
$\def\s{\mathbb s}$
$\def\x{\mathbf x}$
$\def\y{\mathbf y}$
$\def\o{\%*\%}$

##Introduction

Brief review of the extinction/establishment question, the use of branching processes for single and multiple type. 

Brief review of size-structured models of the IPM type

Statement of main goals: adapt the methods of continous-state branching processes to IPMs. 

##Models and methods

### The individual based IPM
We consider an individual- and size- based model where the set of all possible individual states (e.g. age, size, etc.) lies in a compact metric space $X$. For example, for the standard size-structured IPM, $X=[a,b]$ is the interval of sizes. For a mixture of age and size stucture, $X=\{1,\dots,T\}\times [a,b]$ where $T$ is the maximal age. As we only consider populations with a finite number of individuals, the state of the population at any point of the time is characterized by the sizes $(x_1,x_2,\dots, x_k)$  of individuals within the population  and how many individuals are of a given size $(n_1,n_2,\dots, n_k)$. Specifically, if there $n_1$ individuals of size $x_1$, $n_2$ individuals of size $x_2$,..., $n_k$ individuals of size $x_k$, then the state of the population is given by $(n_1,n_2,\dots, n_k; x_1,x_2,\dots, x_k)$. We denote the set of all possible population states is
\[
\S= \{(\n,\x)=(n_1,\dots, n_k, x_1\dots , x_k): k,n_i\in \N, x_i \in X\} \cup \{0\}
\]
where $\N=\{1,2,3,\dots\}$ denotes the natural numbers and $0$ is the extinction state i.e. no individuals in the population.

Let  $\s_t=( \n, \x)\in \S$ be the population state at time $t$. The dynamics of $\s_t$ are determined by a set of probabilistic rules that determine the contribution of each individual in the population to the population in next time step $t+1$. Consistent with standard branching process theory, we assume that each individual in the population updates independent of all other individuals. The update rule for an individual of size $x$ is, in general, given by a probability measure $m(x,d\s)$ on the state space $\S$. Specically, the probability an individual state $x$ is "replaced" by some collection of individuals $\s$ in $A\subset\S$ is given by
\[
\P[\s_1\in A| \s_0 =(1,x)]=\int_A m(x,d\s)
\]
where the left hand side reads "the probability the population is in some state $A$ at time $t=1$ after initially having only one individual in state $x$." These "replacements" may correspond to an individual surviving and growing (i.e. changing state) and having offspring. In the next section, we provide very specific examples of how these measures might be defined. 

The stochastic dynamics of the entire popoulation is given by the following probabilistic update rule. If the population state is currently $\s_t=(n_1,\dots,n_k,x_1,\dots,x_k)$, then 

1. for each of the $n_i$ individuals in state $i$, randomly and indepedently choose the number of replacement individuals from distribution $m(d\,\s,x_i)$.
2. repeat step 1. for all different types in the population. 
3. determine the new population state by identifying all the types of replacement individuals and the total numbers of individuals in each state. 

As with single- and multiple-type branching processes, we can characterize the probabilistic state of the system using probability generating functionals $\Phi$ (pgfs). In the case of these individual-based IPMs, these pgfs take continuous functions $h:X\to \R$  to continuous functions of the same type. To define this pgf, we introduce the following notation. Given a continuous function $h:X\to\R$ and $\s\in \S$, let 
\[
h^\s=
\left\{
\begin{array}{cc}
\prod_{i=1}^k h(x_i)^{n_i}&\mbox{ if }\s=(n_1,\dots,n_k,x_1,\dots,x_k)\\
1 &\mbox{ if }\s=0
\end{array}
\right.
\]
Now, define the pgf by 
\[
\Psi(h)(x)=\int h^\s \,m(d\s,x)
\]
The relevance of the pgf to extinction is based on two facts. The first fact, which stems immediately from the definition, is that if $h$ is the zero function (denoted $0$), then 
\[
\Psi(O)(x)=\int 1 \,m(d\s,x)= \P[\s_1=0|\s_0=(1,x) ]
\]
is the probability the population goes extinct in one time step given that initially it consisted of one individual is state $x$. To state the second fact, define 
\[
\Psi^t(h)=\underbrace{\Psi(\Psi(\dots \Psi}_{\mbox{$t$ times}}(h)\dots))
\]
to be the $t$-fold composition of $\Psi$ with itself. We claim that 
\[
\Psi^t(0)(x)=\P[\s_t=0|\s_0=(1,x)]
\]
is the population is extinct by time $t$ (or sooner) given that it initially consisted of one individual in state $x$. To see why, we argue by induction. The first fact proves that the statement holds for $t=1$. Now suppose the assertion holds for $t$, we will show it holds for $t+1$. 
\]





While the set of probabilitistic update rules can be fairly general, we focus on a relatively standard IPM set up in which there is size-dependent survival followed by size-dependent growth and reproduction. Let $s(x)$ be the probability that an individual of state $x$ survives to the next time step. Let $G(y,x)$ be the growth kernel conditioned on survival i.e. $G(y,x)dy$ is the ``infinitesmal'' probability that a surviving individual of size $x$ grows to size $y$ in the next year. Let $p_k(x)$ be the probability that an individual of size $x$ produces $k$ offspring. Let $e(y,x)dy$ be the infinitesmal probability that an offspring from a parent of size $x$ is of size $y$. We assume that the size of each offspring is independent of all other offspring and the total number of offspring. While this assumption may be reasonable for some species (e.g. many plants and sessile invertebrates), it is likely to be violated for other species (e.g. large mammals or birds). Thus, future development of these methods should account for these correlations.  

Under these assumptions, the state $\s_{t+1}$ of the population is determined by the following update rule. *For each individual in the population at time $t$,*

1. The individual survives with probability $s(x)$ where $x$ is the size of the focal individual. 
2. If the individual survives, then draw its size $y$ from the density $G(y,x)$
3. If the individual survives, randomly draw its number of offspring from the distribution $p_0(x),p_1(x),\dots$
4. For each offspring, randomly draw its size from the density $e(y,x)$

### Probability generating functionals and extinction probabilities
As with single- and multiple-type branching processes, we can characterize the probabilistic state of the system using probability generating functionals $\Phi$ (pgfs). In the case of these individual-based IPMs, these pgfs take continuous functions on $[0,1]$ to continuous function on $[0,1]$.  

To write down  $\Phi$, we need the probability generation function for the offspring distribution for an individual of size $x$: 
\[
\psi_x(z)=\sum_{k=0}^\infty p_k(x)z^k
\]
where $z$ takes on values in $[0,1]$. Recall that  $\psi_x(z)$ is called a probability generating function as it includes the probabilistic information about the offspring distribution. Specifically, 
\[
\frac{d^k}{dz^k}\psi_x(0)/k!=p_k(x)=\mbox{probability of having $k$ offspring}
\]
and
\[
\frac{d}{dz}\psi_x(1)=\sum_k k p_k(x)=\mbox{expected number of offspring}.
\]

With $\psi_x$ in hand, probability generating functional $\Phi$ is given by
\[
\Phi(h)(x)=1-s(x)+s(x)\times \int g(y,x)h(y)dy\times \psi_x\left(\int h(y)e(y,x)dy\right).
\]
This functional has the property that 


This functional has the nice property that if $\s_0=(1,x)$ then the probability of extinction by $t$ of the population is given by 
\[
E(t,x):=\Phi^t(h)(\mathbf{0})(x)
\]
where $\mathbf{0}$ denotes the zero function from $[0,1]$ to $[0,1]$ and $\Phi^t$ denotes the composition of $\Phi$ with itself $t$ times. More generally, for any initial states $\s_0=(\n,\x)$ of the popoulation, independence among individuals implies that the proability of extinction by time $t$ is given by 
\[
\prod_i E(t,x_i)^{n_i}.
\]

### Sensitivity formulas

Suppose that the IBIPM depends on some parameter $a$. Then the pgf $\Phi$ and extinction probabilities $E(t,x)$ will also depend on $a$. A simple computation reveals that the function $E(t,\cdot)$ satifies the following recursion
\[
\frac{\partial E}{\partial a}(t,\cdot)=
\frac{\partial \Phi}{\partial a}(E(t-1,\cdot))+D\Phi(E(t-1,\cdot))\frac{\partial E }{\partial a}(t-1,\cdot)
\]
where $D\Phi$ denotes the derivative of $\Phi$ 
and, consequently, can be solved for interatively. 





First, clear all the variables and load the build of the IPM which I saved in the IPMs.Rdata file. Then pull out the key functions from the IPM build which are 
$s(x)$ the size-dependent survival function, probability density $g(y,x)$ of growing from size x to y, the mean number of offspring $f(x)$ produced by an individual of size $x$ given the individual is having offspring, the probability $p_f(x)$ of having offspring at size $x$, and $os(y)$ the probability density of an offspring being size $y$ at the next census.

```{r}
rm (list = ls ())
load("IPMs.Rdata")
g=function(y,x)Growth(y,x)
s=function(x)Survival(x)
f=function(x)f.fecundity(x)*establishment.prob
pf=function(x)1
os=function(y)dnorm(y,mean=recruit.size.mean,sd=recruit.size.sd)
```
Now comes the important new piece. Need to define the probability generating function associated with the fecundity function. Since we used the Poisson family for getting the fecundity function, I assume that the number of offspring is Poisson distributed with mean $f(x)$ for an individual of size $x$. Hence, the probability generating function (with size $x$ treated like a parameter) is given by  

```{r}
phi=function(x,s)exp(f(x)*(s-1))
```

Using all of these pieces, we can define the probability generating functional for individual based IPM by 
\[\Psi(h)(x)=\left(1-p_f(x)+p_f(x)\phi\left(x,\int_a^b os(y) h(y) dy\right)\right)\left(1-s(x)
						+s(x)\int_a^b g(y,x)h(y)dy\right)\]
where $h$ is a continuous function from $[a,b]$ to $[0,1]$.

To create this probability generating functional numerically, I use the grid on x values xs which go from the minimum size $\alpha$ to the maximum size $\beta$ with n bins. 

```{r}
n=100
xs=seq(alpha,beta,length=n)
dx=xs[2]-xs[1]
```

Now create the survival, probability of having offspring, and offspring size vectors. 

```{r}
s.mat=s(xs)
pf.mat=pf(xs)
os.mat=os(xs)*dx
```
We need to make sure that the o.mat integrates to one i.e. there is no eviction. Eviction creates a major problem for the probability generating functionals. 

```{r}
sum(os.mat)
```
As this sum is pretty close to one, I just renormalize it. 

```{r}
os.mat=os.mat/sum(os.mat)
sum(os.mat)
```

Next need to define the growth matrix and deal with the eviction issue. In this case, I am treating eviction as mortality as this is consistent with what was being done in the Nicols et al. paper. The new growth model is s.evict*g.evict which agrees with the orginal growth kernel g but has a column stochastic matrix g.evict. Note: Most of this eviction is occuring at negative sizes. 

```{r}
g.mat=outer(xs,xs,g)*dx
q.evict=1-colSums(g.mat) 
g.evict=g.mat%*%diag(1/(1-q.evict))
s.evict=(1-q.evict)*s.mat
```

Now, we are ready to create the discretized probability generation function which takes vectors of length n (i.e. the discretized function h) and returns vectors of length n. Note: I need to take the transpose to take integrals down columns.

```{r}
Psi=function(h){
	h.new=(s.evict*(t(g.evict)%*%h)+1-s.evict)*(1-pf(xs)+pf(xs)*phi(xs,os.mat%*%h))
	return(h.new)
}
```

We can use this functional to determine how the probability of extinction varies in time. In particular, iterating the $h=0$ function for $t$ time steps yields $\Psi^t(h)$ where $\Psi^t(h)(x)$ is the probability of the population going extinct by year $t$ given initially there was one individual of size $x$ in the population. The following function iterates the discretized $h=0$ function until time $T$ and returns a matrix of dimension $n\times (T+1)$ whose $t-1$-th column correspondds to $\Psi^t(h)$.
 
```{r}
Psi.iterate=function(T){
	hs=matrix(0,T+1,n)
	for(t in 1:T){
		hs[t+1,]=Psi(hs[t,])
		}
	return(hs)
}
```

OK. Lets try this function out and plot the probabilities of extinction as functions of time for several sizes. 

```{r}
T=15
out=Psi.iterate(T)
sizes=seq(1,n,length=50)
matplot(0:T,out[,sizes],type='l',lwd=2,lty=1,bty="n",col=grey(seq(0.1,0.9,length=length(sizes))),xlab="time",ylab="probability of extinction by time t")
```

Can also plot exinction by time 10 as a function of the initial size of the "founding individaul"

```{r}
plot(out[11,],type="l",lwd=3,xlab="size",ylab="probability of extinction by time 10")
```

To scale things up to an entire population, we can introduce the following function with two inputs: N vector of length $n$ which specifies the initial number of individuals in each size bin, and $T$ the length of the time to look things over. The function returns a vector of length $T+1$ corresponding to the probabilities of extinction by time $t$ or sooner. 

```{r}
PVA=function(N,T){
	hs=Psi.iterate(T)
	output=numeric(T+1)
	for(t in 1:(T+1)){
		output[t]=prod(hs[t,]^N)
	}
	return(output)
}
```

Lets try this out by considering a population of 100 individuals of the smallest size.

```{r}
T=25
N=rep(0,n)
N[1]=100
out=PVA(N,T)
plot(0:T,out,typ="l",lwd=3,bty="n",xlab="time t",ylab="probability of extinction by year t")
abline(h=0.01)
```

Clearly these probabilities asymptote. The following function computes this asymptotic probability of extinction by iterating toward the steady state. 

```{r}
AE=function(tol=0.0001){
  h=rep(0,n)
  diff=1
  while(diff>tol){
    h.old=h
    h=Psi(h)
    diff=sum(abs(h.old-h))
  }
  return(h)
}
```
Lets try this out. 

```{r}
h=AE()
plot(xs,h,type="l",xlab="size",ylab="asymptotic extinction probability",lwd=3)
```

Can see that the asymptotic exinction probability tends to decrease with the size of the founding individual but at large sizes begins increasing again. This latter trend is due to the eviction in the model at large sizes.
