---
title: 'Individual-based Integral Projection Models: The role of size-structure on
  extinction risk and establishment success'
author: "Sebastian Schreiber and Noam Ross"
date: "April 8, 2015"
output: html_document
---
$\def\N{\mathbb N}$
$\def\R{\mathbb R}$
$\def\P{\mathbb P}$
$\def\N{\mathbb N}$
$\def\S{\mathcal S}$
$\def\n{\mathbf n}$
$\def\s{\mathbb s}$
$\def\x{\mathbf x}$
$\def\y{\mathbf y}$
$\def\o{\%*\%}$

##Introduction

The likelihoods of extinction or establishment success lie on opposing sides of a theoretican's coin used to address questions in conservation biology, restoration ecology, biological invasions and population genetics. These likelihoods stem from populations consisting of a finite number of individuals each of which faces a positive risk of mortality on any given day. Moreover, these extinction and establishment likelihoods are shaped by population structure in which individuals may differ in age, size, geographical location, or other important distinguishing features. Multi-type branching processes, in which individuals survive, grow, and repoduce independent of one another, are a natural stochastic counterpart of matrix models (Caswell 2001). These models allow one to examine how extinction risk or establishment success depend on the population size and its distribution across a finite number of states (e.g. ages, size classes, patches). 

When collecting demographic data, one commonly makes continuous measurements (e.g. mass, length) about individuals. Consequently, since their introduction in the early 2000s, there has been a surge of interest in integral projection models (IPMs) that account for continuous population structure and correspond to infinite-dimensional analog of matrix models. The individual based counterparts of these models were effectively introduced in the 1950s by Theodore Harris. He called them continuous-state branching processes. Here, we describe a generalization of these models as well an explicit analytical method for computing time-dependent extinction probabilities associated with these individual based IPMs. We illustrate how to implement these methods in R using the IPM of XXX developed by XXX. Sensitivity and elasticity formulas for these extinction probabilities are also provided. 



##Models and methods

### The General Individual Based IPM
We consider an individual-based model where the set of all possible individual states (e.g. age, size, etc.) lies in a compact metric space $X$. For example, for the standard size-structured IPM, $X=[a,b]$ is the interval of sizes. For a mixture of age and size stucture, $X=\{1,\dots,T\}\times [a,b]$ where $T$ is the maximal age. As we only consider populations with a finite number of individuals, the state of the population at any point of the time is characterized by the sizes $(x_1,x_2,\dots, x_k)$  of individuals within the population  and how many individuals are of a given size $(n_1,n_2,\dots, n_k)$. Specifically, if there $n_1$ individuals of size $x_1$, $n_2$ individuals of size $x_2$,..., $n_k$ individuals of size $x_k$, then the state of the population is given by $(n_1,n_2,\dots, n_k; x_1,x_2,\dots, x_k)$. Following Harris (XXXX), we denote the set of all possible population states is
\[
\S= \{(\n,\x)=(n_1,\dots, n_k, x_1\dots , x_k): k,n_i\in \N, x_i \in X\} \cup \{0\}
\]
where $\N=\{1,2,3,\dots\}$ denotes the natural numbers and $0$ is the extinction state i.e. no individuals in the population.

Let  $\s_t=( \n, \x)\in \S$ be the population state at time $t$. The dynamics of $\s_t$ are determined by a set of probabilistic rules that determine the contribution of each individual in the population to the population in next time step $t+1$. Consistent with standard branching process theory, we assume that each individual in the population updates independent of all other individuals. The update rule for an individual of size $x$ is given by a probability measure $m(x,d\s)$ on the state space $\S$. Specically, the probability an individual in state $x$ contributes $\s$ individuals to the population in the next time step where $\s$ lies in a subset $A\subset \S$ equals
\[
\P[\s_1\in A| \s_0 =(1,x)]=\int_A m(x,d\s)
\]
where the left hand side reads "the probability the population state lies $A$ at time $t=1$ after initially having only one individual in state $x$." These "contributions" may correspond to an individual surviving and changing state (e.g. growing in size), or having offspring. 

The stochastic dynamics of the entire popoulation is given by a probabilistic update rule determined by the probability measures $m(x,d\s)$. Specifically, if the population state is currently $\s_t=(n_1,\dots,n_k,x_1,\dots,x_k)$, then 

1. for each of the $n_1$ individuals in state $x_1$, randomly and indepedently choose the number of replacement individuals from distribution $m(x_1,d\,\s)$.
2. repeat step 1. for the types $x_2,\dots, x_k$.
3. determine the new population state by identifying the states of all individuals and counting the total number of individuals in each of these states. 

This iterative algorithm can be used to create individual based simulations of the individual based IPM. As with any branching process, stochastic realizations of this process, with probability one, either go to extinction in finite time, or the population size asymptotically approaches infinity. 

### Probability generating functionals and extinction probabilities

As with single- and multiple-type branching processes, we can characterize the probabilistic state of the system using probability generating functionals $\Phi$ (pgfs). In the case of these individual-based IPMs, these pgfs take continuous functions $h:X\to \R$  to continuous functions of the same type. To define this pgf, we introduce the following notation. Given a continuous function $h:X\to\R$ and $\s\in \S$, let 
\[
h^\s=
\left\{
\begin{array}{cc}
\prod_{i=1}^k h(x_i)^{n_i}&\mbox{ if }\s=(n_1,\dots,n_k,x_1,\dots,x_k)\\
1 &\mbox{ if }\s=0
\end{array}
\right.
\]
Using this notation, we define the pgf by 
\[
\Psi(h)(x)=\int h^\s \,m(x,d\s).
\]
Namely, $\Psi(h)(x)$ corresponds to finding the expected value of $h^\s$ due to the contributions of individuals in the next time step from an individual in state $x$. This expectation corresponds to integrating over all possible populations states in the next time step.  

The relevance of the pgf to extinction probabilities follows from two facts. The first fact, which stems immediately from the definition, is that if $h_0$ is the zero function (i.e. $h_0(x)=0$ for all $x$), then 
\[
\Psi(h_0)(x)=\int 1 \,m(d\s,x)= \P[\s_1=0|\s_0=(1,x)]
\]
is the probability the population goes extinct in one time step given that initially it consisted of one individual is state $x$. To state the second fact, define 
\[
\Psi^t(h)=\underbrace{\Psi(\Psi(\dots \Psi}_{\mbox{$t$ times}}(h)\dots))
\]
to be the $t$-fold composition of $\Psi$ with itself. We claim that 
\[
\Psi^t(h_0)(x)=\P[\s_t=0|\s_0=(1,x)]=:E_t(x)
\]
is the population is extinct by time $t$ (or sooner) given that it initially consisted of one individual in state $x$. To see why, we argue by induction. The first fact proves that the statement holds for $t=1$. Now suppose the assertion holds for $t$, we will show it holds for $t+1$.  On the event that $\s_1=(n_1,\dots,n_k,x_1,\dots,x_k)$, extinction occurs by time $t+1$ only if each of the lineages of the $n_1+\dots +n_k$ go extinct in the next $t$ time steps. As the fates of these lineages are independent of one another, it follows that 
\[
\begin{aligned}
\P[s_{t+1}=0|\s_0=(1,x),\s_1=(n_1,\dots,n_k,x_1,\dots,x_k)]&= \prod_{i=1}^k \P[\s_t=0|\s_0=(1,x_i)]^{n_i}\\
&=\prod_{i=1}^k\left(\Psi^t(h_0)(x_i)\right)^{n_i}=\Psi^t(h_0)^{\s_1}
\end{aligned}
\]
where the second equality follows from our inductive hypothesis. By the law of total probability
\[
\P[s_{t+1}=0|\s_0=(1,x)]=\int [\Psi^t(h_0)]^\s \,m(d\s,x)
\]
which, by definition, equals $\Psi^{t+1}(0)(x)$ as claimed. 

As individuals update independent of one another, the probability of the population going extinct by time $t$ for any inititial condition $\s=(n_1,\dots,n_k,x_1,\dots,x_k)$ equals 
\[
\P[\s_t=0|\s_0=\s]=\Psi(h_0)^\s.
\]
This analytic expression allows to efficiently compute extinction probabilities by constructing a numerical approximation of the pgf and iterating it with an initial condition of a zero vector which corresponds to the numerical approximation of the zero function. 

As $E_0(x)\le E_1(x),\le E_2(x)\dots$ for any $x\in X$, there is a well defined limit corresponding to the probability of eventual extinction:
\[
E_\infty(x):=\lim_{t\to\infty} E_t(x).
\]
Using moment generating functionals, Harris provided a criterion for when $E_\infty(x)<1$ for all $x$ or $E_\infty(x)=1$ for all $x$. Under suitable technical assumptions, this limit theorem implies that $E_\infty(x)=0$ for all $x$ whenever the dominant eigenvalue of the meanfield IPM is less than or equal to one, and $E_\infty(x)>0$ for all $x$, otherwise.  



### Sensitivity Formulas

To examine the sensitivity of the extinction probability $E_t(x)$ to a parameter $a$ in the IBIPM (e.g. the slope or intercept of the logistic regression for surival or the linear regression for the growth kernel), the chain rule implies that 
\[
\frac{d}{da}E_t(x)=\left(\prod_{s=0}^{t-1} \frac{d\Psi}{da}(E_s)\right)(x)
\]
where the product refers to composition of the linear operators given by taking the derivative of the pgf with respect to the parameter $a$. From these sensitivities, we can compute the elasticities of these extinction probabilities to $a$ which describe proportional changes in $E_t(x)$ due to proportional changes in $a$. These elasticies are given by 
\[
 \frac{a}{E_t(x)}\left(\prod_{s=0}^{t-1} \frac{d\Psi}{da}(E_s)\right)(x).
\]

## A Numerical Illustration

To illustrate how these general methods can be applied to a data set, we develop an individual-based IPM based on **add details about the endangered plant species and the work of Nicols et al**. 

For the mean-field IPM, Nicols et al. had a model of the form 
\[
N_{t+1}(x)=\int_a^b s(y)G(y,x)+e(x)f(y)N_t(y)\,dy
\]
where $s(x)$ is the probability of surviving to the next year for individuals of size $y$, $G(y,x)dy$ is the infinitesmal probability that a surviving individual of size $x$ is size $y$ in the next year, $f(x)$ is the mean number of offspring produced by an individual of size $x$, and $e(x)$ is the infinitesmal probability of an offspring is of size $x$ at the time of the annual census. 

The following code loads the functions for the mean field IPM: 
```{r}
rm (list = ls ())
load("IPMs.Rdata")
g=function(y,x)Growth(y,x)
s=function(x)Survival(x)
f=function(x)f.fecundity(x)*establishment.prob
pf=function(x)1
e=function(y)dnorm(y,mean=recruit.size.mean,sd=recruit.size.sd) 
```

The kernels $s(x)$, $G(y,x)$, and $e(x)$ provide us with all the information the individual-based IPMs requires for probabilistic updating individuals for survival, growth, and size at first census. The fecundity kernel $f(y)$, however, only specifies the mean number of offspring produced, but for an individual-based IPM, we need the distribution of the number of offspring produced by an individual. Fortunately, when using GLMs to model fecundity data, we are often getting this extra information for free. For example, one might use the Poisson family in a GLM to model the fecundity data.  In which case, the mean $f(x)$ also specifies the distribution. Alternatively, one might use multi-parameter distributions such as the negative binomial or mixtures of several distributions.

Consisent with the analysis of Nicols et al, we assume this distribution for an individual of size $y$ is Poisson distributed with mean $f(y)$. Recall that pgf for a Poisson distribution with mean $\lambda$ is $\phi(s)=\exp(\lambda(s-1))$ where $s$ is a dummy variable. Hence, the pgf for the number of offspring of an individual of size $x$ is given by 
```{r}
phi=function(x,s)exp(f(x)*(s-1))
```
We will need this pgf to construct the pfg $\Psi$ of the individual-based IPM. 

To define $\Psi$, notice that the contributions of an individual of size $x$ to the population in the next time step involves the sum of two independent random variables. There is the contribution due to survival and growth, and the contribution due to reproduction. We can define a pgf for each of these processes seperately. For the survival and growth pgf $\Psi_g$, $\Psi_g(h)(x)$ corresponds to integrating $h^\s$ over all contributes $\s$ due to an individual of size $x$ surviving and growing. These possible states are of two types: $\s=\emptyset$ corresponding to an individual dying and $\s=(1,y)$ corresponding to an individual suriving and growing to size $y$. The first event occurs with probability $1-s(x)$ and the infinitesmal probability of the second event is $s(x)G(y,x)dy$. As $h^\s=1$ on the event of death and $h^\s=h(y)$ on the event $\s=(1,y)$, integrating over all possible contributions due to survival and growth yields 
\[
\Psi_{g}(h)(x)=(1-s(x))\times 1 + s(x)\int h(y)G(y,x)dy.
\]
For the pgf $\Psi_f$ corresponding to contributions due to fecundity, $\Psi_f(h)(x)$ is given by integrating $h^\s$ over all possible states $\s$ corresponding to the offspring produced by an individual of size $x$. With this two pgfs, we can use a fundamental property of pgfs: the pgf for a sum of indepedent random variables is the product of the pgfs of these random variables. Hence, our pgf $\Psi$ for the individual-based IPM will be given by 
\[
\Psi=\Psi_g \times \Psi_f
\]

But what about $\Psi_f$? To write this down, we can take advantage of the fact that the reproductive contribution of an individual of size $x$ corresponds to a Poisson number of offspring with mean $f(x)$ whose sizes are drawn *independently* from the same offspring distribution. To make use of this observation, we can condition on the number of offspring an individual has. Lets say our individual of size $x$ has $N$ offspring. Then its contribution is a sum of $N$ indendent random variables taking values of the form $\s=(1,y)$. The pgf $\Psi_{kid}$ associated with one of these contributions is given by 
\[
\Psi_{kid}(h)(x)=\int h(y)e(y)dy
\]
as $h^{{1,y}}(x)=h(y)$ and $e(y)dy$ is the infinitesmal probability of an offspring being of size $y$. Since there are $N$ kids independent of one another, the pfg for this sum is given by the product of the pfgs:
\[
\Psi_{N\,kids}(h)(x)=\left(\int h(y)e(y)dy\right)^N.
\]
Finally, to get $\Psi_f$, we can sum over all possible number of kids weighted by their probabilities:
\[
\Psi_f(h)(x)=\sum \frac{\exp(-f(x))f(x)^N}{N!} \Psi_{kid}(h)(x)^N
\]
but this corresponds simply to 
\[
\Psi_f(h)(x)=\phi(x, \Psi_{kid}(h)(x))=\phi(x,\int h(y)e(y)dy)
\]
Thus we have
\[
\Psi(h)(x)=\left((1-s(x))\times 1 + s(x)\int h(y)G(y,x)dy\right)\phi(x,\int h(y)e(y)dy)
\]

To create this probability generating functional numerically, we can use the grid on x values xs which go from the minimum size $\alpha$ to the maximum size $\beta$ with n bins. 

```{r}
n=100
xs=seq(alpha,beta,length=n)
dx=xs[2]-xs[1]
```

Now create the survival, probability of having offspring, and offspring size vectors. 

```{r}
s.mat=s(xs)
pf.mat=pf(xs)
os.mat=e(xs)*dx
```
We need to make sure that the o.mat integrates to one i.e. there is no eviction. Eviction creates a major problem for the probability generating functionals. 

```{r}
sum(os.mat)
```
As this sum is pretty close to one, I just renormalize it. 

```{r}
os.mat=os.mat/sum(os.mat)
sum(os.mat)
```

Next need to define the growth matrix and deal with the eviction issue. In this case, I am treating eviction as mortality as this is consistent with what was being done in the Nicols et al. paper. The new growth model is s.evict*g.evict which agrees with the orginal growth kernel g but has a column stochastic matrix g.evict. Note: Most of this eviction is occuring at negative sizes. 

```{r}
g.mat=outer(xs,xs,g)*dx
q.evict=1-colSums(g.mat) 
g.evict=g.mat%*%diag(1/(1-q.evict))
s.evict=(1-q.evict)*s.mat
```

Now, we are ready to create the discretized probability generation function which takes vectors of length n (i.e. the discretized function h) and returns vectors of length n. Note: I need to take the transpose to take integrals down columns.

```{r}
Psi=function(h){
	h.new=(s.evict*(t(g.evict)%*%h)+1-s.evict)*(1-pf(xs)+pf(xs)*phi(xs,os.mat%*%h))
	return(h.new)
}
```

We can use this functional to determine how the probability of extinction varies in time. In particular, iterating the $h=0$ function for $t$ time steps yields $\Psi^t(h)$ where $\Psi^t(h)(x)$ is the probability of the population going extinct by year $t$ given initially there was one individual of size $x$ in the population. The following function iterates the discretized $h=0$ function until time $T$ and returns a matrix of dimension $n\times (T+1)$ whose $t-1$-th column correspondds to $\Psi^t(h)$.
 
```{r}
Psi.iterate=function(T){
	hs=matrix(0,T+1,n)
	for(t in 1:T){
		hs[t+1,]=Psi(hs[t,])
		}
	return(hs)
}
```

OK. Lets try this function out and plot the probabilities of extinction as functions of time for several sizes. 

```{r}
T=15
out=Psi.iterate(T)
sizes=seq(1,n,length=50)
matplot(0:T,out[,sizes],type='l',lwd=2,lty=1,bty="n",col=grey(seq(0.1,0.9,length=length(sizes))),xlab="time",ylab="probability of extinction by time t")
```

Can also plot exinction by time 10 as a function of the initial size of the "founding individaul"

```{r}
plot(out[11,],type="l",lwd=3,xlab="size",ylab="probability of extinction by time 10")
```

To scale things up to an entire population, we can introduce the following function with two inputs: N vector of length $n$ which specifies the initial number of individuals in each size bin, and $T$ the length of the time to look things over. The function returns a vector of length $T+1$ corresponding to the probabilities of extinction by time $t$ or sooner. 

```{r}
PVA=function(N,T){
	hs=Psi.iterate(T)
	output=numeric(T+1)
	for(t in 1:(T+1)){
		output[t]=prod(hs[t,]^N)
	}
	return(output)
}
```

Lets try this out by considering a population of 100 individuals of the smallest size.

```{r}
T=25
N=rep(0,n)
N[1]=100
out=PVA(N,T)
plot(0:T,out,typ="l",lwd=3,bty="n",xlab="time t",ylab="probability of extinction by year t")
abline(h=0.01)
```

Clearly these probabilities asymptote. The following function computes this asymptotic probability of extinction by iterating toward the steady state. 

```{r}
AE=function(tol=0.0001){
  h=rep(0,n)
  diff=1
  while(diff>tol){
    h.old=h
    h=Psi(h)
    diff=sum(abs(h.old-h))
  }
  return(h)
}
```
Lets try this out. 

```{r}
h=AE()
plot(xs,h,type="l",xlab="size",ylab="asymptotic extinction probability",lwd=3)
```

Can see that the asymptotic exinction probability tends to decrease with the size of the founding individual but at large sizes begins increasing again. This latter trend is due to the eviction in the model at large sizes.
